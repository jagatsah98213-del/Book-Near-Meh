<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Book Near Me ‚Äî Seller & Buyer</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1724; --panel:rgba(255,255,255,0.06); --text:#e6eef8; --muted:#90a0b6;
  --accent-start:#7c3aed; --accent-end:#06b6d4;
}
[data-theme="light"]{
  --bg:#f4f7fb; --panel:rgba(255,255,255,0.92); --text:#0b1220; --muted:#334155;
}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column;}
header{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; backdrop-filter: blur(6px);}
.brand{display:flex; align-items:center; gap:12px;}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(8,8,15,0.4);}
.title{font-weight:600;font-size:18px;}
.controls{display:flex; gap:10px; align-items:center;}
.btn{border:none;padding:10px 12px;border-radius:10px;cursor:pointer;background:var(--panel);color:var(--text);font-weight:600;}
.btn.primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;box-shadow:0 6px 18px rgba(0,0,0,0.35);}
main{display:grid; grid-template-columns:420px 1fr; gap:18px; padding:18px; flex:1; min-height:0;}
.panel{background:var(--panel); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.5); overflow:auto; max-height:calc(100vh - 120px);}
#map{width:100%; height:calc(100vh - 164px); border-radius:12px; box-shadow:0 8px 26px rgba(2,6,23,0.6);}
.book-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; margin-bottom:12px; display:flex; gap:10px; align-items:flex-start;}
.book-card img{width:88px;height:110px;object-fit:cover;border-radius:8px;flex-shrink:0;box-shadow:0 6px 16px rgba(2,6,23,0.6);}
.book-meta{flex:1;}
.book-meta h4{margin:0 0 6px 0;font-size:15px;}
.book-meta p{margin:0;color:var(--muted);font-size:13px;}
.small{font-size:12px;color:var(--muted); margin-top:8px;}
.field{margin-top:12px;}
input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--text);}
.user-menu{position:relative;}
.menu{position:absolute; right:0; top:48px; background:var(--panel); border-radius:10px; padding:8px; min-width:240px; box-shadow:0 8px 24px rgba(2,6,23,0.5);}
.menu button{display:block;width:100%;text-align:left;padding:8px;border-radius:8px;border:none;background:transparent;color:var(--text);cursor:pointer;}
label.switch{display:inline-flex; gap:8px; align-items:center;}
.tab-panel{display:none; background:rgba(255,255,255,0.06); backdrop-filter: blur(14px); padding:16px; border-radius:14px; margin-top:12px;}
.tab-panel.active{display:block;}
.processing{margin-top:8px;font-size:13px;color:var(--accent-end);}
@media(max-width:980px){main{grid-template-columns:1fr; padding:12px} #map{height:60vh}}
</style>
</head>
<body data-theme="dark">

<header>
  <div class="brand">
    <div class="logo">B</div>
    <div>
      <div class="title">Book Near Me</div>
      <div class="muted" style="font-size:12px">Realtime book map</div>
    </div>
  </div>

  <div class="controls">
    <label class="switch muted">
      <input id="modeToggle" type="checkbox" style="width:0;height:0;opacity:0;"/>
      <span id="modeLabel" class="muted">Dark</span>
    </label>

    <button class="btn" id="myLocationBtn">üìç My Location</button>
    <button class="btn primary" id="subscribeBtn">üì∫ Subscribe NS Jagat</button>
  </div>
</header>

<main>
  <aside class="panel" id="leftPanel">
    <div style="font-weight:600; margin-bottom:8px;">Seller / Buyer Actions</div>

    <button class="btn primary" id="postTabBtn">Post Your Book</button>
    <button class="btn" id="filterTabBtn">Filter Books</button>

    <!-- POST YOUR BOOK TAB -->
    <div class="tab-panel" id="postTab">
      <div class="field">
        <select id="bookType">
          <option value="individual">Individual Book</option>
          <option value="academic">Academic Book Set</option>
        </select>
      </div>
      <div class="field"><input id="titleIn" placeholder="Book Title" type="text"></div>
      <div class="field"><input id="authorIn" placeholder="Author / Set Name" type="text"></div>
      <div class="field"><input id="whatsappIn" placeholder="WhatsApp Number" type="text"></div>
      <div class="field"><input id="emailIn" placeholder="Email (optional)" type="text"></div>
      <div class="field"><select id="categoryIn"><option>Fiction</option><option>Non-Fiction</option><option>Education</option><option>Technology</option><option>Kids</option></select></div>
      <div class="field"><input id="imageIn" type="file" accept="image/*"></div>
      <div class="field"><button class="btn primary" id="postBookBtn">Post Book</button></div>
      <div class="processing" id="processingText">Processing: 0%</div>
      <div class="footer-note">Your book info will go for review. Data is safe.</div>
    </div>

    <!-- FILTER BOOKS TAB -->
    <div class="tab-panel" id="filterTab">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:6px;">
        <div style="font-weight:600">Available Books</div>
        <select id="sortSelect" class="btn" style="background:transparent; padding:8px 10px;">
          <option value="recent">Newest</option>
          <option value="nearest">Nearest</option>
        </select>
      </div>
      <div id="booksList"></div>
    </div>

  </aside>

  <section>
    <div id="map"></div>
  </section>
</main>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyB3kahd5nJOga4YUZnHATrPHu4Ief7b_64",
  authDomain: "book-nearme.firebaseapp.com",
  projectId: "book-nearme",
  storageBucket: "book-nearme.appspot.com",
  messagingSenderId: "857560283510",
  appId: "1:857560283510:web:9c4bd7f7dca04c35552257"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// THEME TOGGLE
const modeToggle = document.getElementById('modeToggle');
const modeLabel = document.getElementById('modeLabel');
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  modeLabel.innerText = theme==='dark'?'Dark':'Light';
  localStorage.setItem('bm_theme',theme);
}
modeToggle.addEventListener('change',()=>applyTheme(modeToggle.checked?'light':'dark'));
applyTheme(localStorage.getItem('bm_theme')||'dark');

// TAB SWITCH
const postTabBtn = document.getElementById('postTabBtn');
const filterTabBtn = document.getElementById('filterTabBtn');
const postTab = document.getElementById('postTab');
const filterTab = document.getElementById('filterTab');
postTabBtn.addEventListener('click',()=>{ postTab.classList.add('active'); filterTab.classList.remove('active'); });
filterTabBtn.addEventListener('click',()=>{ filterTab.classList.add('active'); postTab.classList.remove('active'); });

// MAP INIT
let map = L.map('map').setView([26, 84],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// SHOW MY LOCATION
document.getElementById('myLocationBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('Geolocation not supported'); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    map.setView([lat,lng],12);
    L.circle([lat,lng],{radius:200,color:'#06b6d4',opacity:0.6}).addTo(map);
  },err=>alert('Location access denied or error'));
});

// SUBSCRIBE BUTTON
document.getElementById('subscribeBtn').addEventListener('click',()=>window.open("https://www.youtube.com/@nsjagat-c?sub_confirmation=1","_blank"));
                                                                                 </script>
                                                                                 <script>
// FIREBASE COLLECTION
const booksCol = db.collection('books');

// LOCAL STORAGE KEY FOR SELLER
const sellerKey = localStorage.getItem('sellerKey') || Date.now().toString();
localStorage.setItem('sellerKey', sellerKey);

// ELEMENTS
const titleIn = document.getElementById('titleIn');
const authorIn = document.getElementById('authorIn');
const whatsappIn = document.getElementById('whatsappIn');
const emailIn = document.getElementById('emailIn');
const categoryIn = document.getElementById('categoryIn');
const bookType = document.getElementById('bookType');
const imageIn = document.getElementById('imageIn');
const postBookBtn = document.getElementById('postBookBtn');
const processingText = document.getElementById('processingText');
const booksList = document.getElementById('booksList');

// IMAGE COMPRESSION FUNCTION
function compressImage(file, maxSizeMB = 1) {
    return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e=>{
            const img = new Image();
            img.src = e.target.result;
            img.onload = ()=>{
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let width = img.width;
                let height = img.height;
                if(width*height > maxSizeMB*1000000){
                    const ratio = Math.sqrt((maxSizeMB*1000000)/(width*height));
                    width = width*ratio;
                    height = height*ratio;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img,0,0,width,height);
                canvas.toBlob(blob=>{
                    resolve(blob);
                }, 'image/jpeg', 0.8);
            }
        }
    });
}

// POST BOOK
postBookBtn.addEventListener('click', async()=>{
    const title = titleIn.value.trim();
    const author = authorIn.value.trim();
    const whatsapp = whatsappIn.value.trim();
    const email = emailIn.value.trim();
    const category = categoryIn.value;
    const type = bookType.value;
    const file = imageIn.files[0];

    if(!title || !author || !whatsapp){ alert('Please fill required fields'); return; }

    processingText.innerText = 'Processing: 0%';

    // COMPRESS IMAGE
    let imgURL = '';
    if(file){
        processingText.innerText = 'Processing: 10%';
        const compressed = await compressImage(file,1);
        const storageRef = storage.ref(`books/${sellerKey}_${Date.now()}.jpg`);
        await storageRef.put(compressed);
        imgURL = await storageRef.getDownloadURL();
        processingText.innerText = 'Processing: 50%';
    }

    // GET LOCATION
    let lat = 0, lng = 0;
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            lat=pos.coords.latitude; lng=pos.coords.longitude;
        });
    }

    // CREATE BOOK DATA
    const bookData = {
        title, author, whatsapp, email, category, type, imgURL,
        sellerKey, status:'pending', lat, lng, createdAt:Date.now()
    };

    // SAVE TO FIRESTORE
    await booksCol.doc(sellerKey+'_'+Date.now()).set(bookData);
    processingText.innerText = 'Processing: 100%';

    // REDIRECT TO WHATSAPP
    const msg = `Hello, I submitted a book for review:\nTitle: ${title}\nAuthor: ${author}\nWhatsApp: ${whatsapp}\nEmail: ${email}\nCategory: ${category}\nType: ${type}`;
    const waUrl = `https://wa.me/9779821367407?text=${encodeURIComponent(msg)}`;
    window.open(waUrl,'_blank');

    alert('Your book has been submitted for review. Your data is safe.');
    loadSellerBooks();
});

// LOAD SELLER BOOKS
async function loadSellerBooks(){
    booksList.innerHTML = '';
    const snapshot = await booksCol.where('sellerKey','==',sellerKey).orderBy('createdAt','desc').get();
    snapshot.forEach(doc=>{
        const b = doc.data();
        const card = document.createElement('div');
        card.className='book-card';
        card.innerHTML=`<div><img src="${b.imgURL||''}" alt=""></div>
            <div class="book-meta">
            <h4>${b.title}</h4>
            <p>Author: ${b.author}</p>
            <p>Status: ${b.status}</p>
            <small>${b.type} ‚Ä¢ ${b.category}</small>
            </div>`;
        booksList.appendChild(card);
    });
}

// INITIAL LOAD
loadSellerBooks();

// SHOW BOOKS ON MAP
async function showBooksOnMap(){
    markersLayer.clearLayers();
    const snapshot = await booksCol.get();
    snapshot.forEach(doc=>{
        const b = doc.data();
        if(b.lat && b.lng){
            const marker = L.marker([b.lat,b.lng]).addTo(markersLayer);
            marker.bindPopup(`<b>${b.title}</b><br>${b.author}<br>${b.type}<br>${b.category}`);
        }
    });
}
showBooksOnMap();
                                                                                 </script>
