<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>BookNearMe</title>

    <!-- Appwrite CDN -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>

    <!-- Leaflet Map CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        #map { height: 60vh; width: 100%; }
        #formBox { padding: 10px; background: #f5f5f5; }
        input, textarea { width: 100%; margin: 5px 0; padding: 10px; }
        button { padding: 10px; width: 100%; background:#000; color:#fff; border:none; }
    </style>
</head>

<body>

<h2 style="text-align:center;">ðŸ“š Book Near Me</h2>

<!-- MAP -->
<div id="map"></div>

<!-- FORM -->
<div id="formBox">
    <h3>Post Your Book</h3>

    <input id="title" placeholder="Book Title">
    <input id="author" placeholder="Author Name">
    <input id="price" placeholder="Price">
    <input id="phone" placeholder="WhatsApp Number">
    <textarea id="desc" placeholder="Description"></textarea>
    <input type="file" id="image">

    <button onclick="submitBook()">Post Book</button>
</div>

<script>
    // ------------------------------
    // 1. INITIALIZE APPWRITE CLIENT
    // ------------------------------
    const client = new Appwrite.Client();
    client
        .setEndpoint("https://sgp.cloud.appwrite.io/v1")
        .setProject("6931939e002870de31b4")
        .setKey("standard_a07eaeb9dd362588d6a2fabdd71303168c19ff3f521aa7070f751c18aeb65e7e900339ca0e6a34d7074f5a1844736d784a02d4032c70320211f0e2979dc478378922ffacd77aa0a04a1f1bb97a4295952b0b10de9f02788dafcf09c66ce0396094c798d4fc9ddae346064cf8228b2542649526765c23c089f6287d9b6734d6ce");

    const db = new Appwrite.Databases(client);
    const storage = new Appwrite.Storage(client);

    const databaseId = "693193d90004270c0877";
    const collectionId = "6fgwsG56jj";
    const bucketId = "693197f300105e288f21";

    // ------------------------------
    // 2. LOAD MAP
    // ------------------------------
    let map = L.map('map').setView([27.7, 85.3], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userLat = null, userLon = null;

    // Detect location
    navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        map.setView([userLat, userLon], 14);
    });

    // ------------------------------
    // 3. SUBMIT BOOK
    // ------------------------------
    async function submitBook() {
        const title = document.getElementById("title").value;
        const author = document.getElementById("author").value;
        const price = document.getElementById("price").value;
        const phone = document.getElementById("phone").value;
        const desc = document.getElementById("desc").value;
        const imageFile = document.getElementById("image").files[0];

        if (!title || !author || !price || !phone || !desc || !imageFile) {
            alert("Please fill all fields.");
            return;
        }

        if (!userLat || !userLon) {
            alert("Location not detected. Enable GPS.");
            return;
        }

        // Upload image
        const uploaded = await storage.createFile(bucketId, Appwrite.ID.unique(), imageFile);

        const fileId = uploaded.$id;

        // Save book record
        const result = await db.createDocument(
            databaseId,
            collectionId,
            Appwrite.ID.unique(),
            {
                title,
                author,
                price,
                phone,
                desc,
                lat: userLat,
                lon: userLon,
                image: fileId
            }
        );

        alert("Book posted successfully!");
        loadBooks();
    }

    // ------------------------------
    // 4. LOAD BOOKS ON MAP
    // ------------------------------
    async function loadBooks() {
        const res = await db.listDocuments(databaseId, collectionId);

        res.documents.forEach(book => {
            if (!book.lat || !book.lon) return;

            let marker = L.marker([book.lat, book.lon]).addTo(map);

            marker.bindPopup(`
                <b>${book.title}</b><br>
                ${book.author}<br>
                Rs. ${book.price}<br>
                <a href="https://wa.me/${book.phone}" target="_blank">WhatsApp Seller</a>
            `);
        });
    }

    loadBooks();
</script>

</body>
</html>
