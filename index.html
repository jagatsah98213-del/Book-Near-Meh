<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Book Near Me ‚Äî Seller & Buyer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1724; --panel:rgba(255,255,255,0.06); --text:#e6eef8; --muted:#90a0b6;
  --accent-start:#7c3aed; --accent-end:#06b6d4;
}
[data-theme="light"]{
  --bg:#f4f7fb; --panel:rgba(255,255,255,0.92); --text:#0b1220; --muted:#334155;
}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column;}
header{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; backdrop-filter: blur(6px);}
.brand{display:flex; align-items:center; gap:12px;}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(8,8,15,0.4);}
.title{font-weight:600;font-size:18px;}
.controls{display:flex; gap:10px; align-items:center;}
.btn{border:none;padding:10px 12px;border-radius:10px;cursor:pointer;background:var(--panel);color:var(--text);font-weight:600;}
.btn.primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;box-shadow:0 6px 18px rgba(0,0,0,0.35);}
main{display:grid; grid-template-columns:420px 1fr; gap:18px; padding:18px; flex:1; min-height:0;}
.panel{background:var(--panel); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.5); overflow:auto; max-height:calc(100vh - 120px);}
#map{width:100%; height:calc(100vh - 164px); border-radius:12px; box-shadow:0 8px 26px rgba(2,6,23,0.6);}
label.switch{display:inline-flex; gap:8px; align-items:center;}
.post-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1000; }
.post-content { background:rgba(255,255,255,0.08); backdrop-filter: blur(14px); padding:28px; border-radius:20px; width:420px; max-width:90%; max-height:90%; overflow:auto; }
.post-content h3{margin-top:0;text-align:center;}
.post-content input, .post-content select{width:100%; margin-top:12px; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.03); color:var(--text);}
.post-content button{margin-top:16px; width:100%; padding:12px; border-radius:14px; border:none; font-weight:600; font-size:15px; background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:white; cursor:pointer;}
@media(max-width:980px){main{grid-template-columns:1fr; padding:12px} #map{height:60vh}}
</style>
</head>
<body data-theme="dark">

<header>
  <div class="brand">
    <div class="logo">B</div>
    <div>
      <div class="title">Book Near Me</div>
      <div class="muted" style="font-size:12px">Realtime book map</div>
    </div>
  </div>

  <div class="controls">
    <label class="switch muted">
      <input id="modeToggle" type="checkbox" style="width:0;height:0;opacity:0;"/>
      <span id="modeLabel" class="muted">Dark</span>
    </label>

    <button class="btn" id="myLocationBtn">üìç My Location</button>
    <button class="btn primary" id="subscribeBtn">üì∫ Subscribe NS Jagat</button>
  </div>
</header>

<main>
  <aside class="panel" id="leftPanel">
    <div style="font-weight:600; margin-bottom:12px">Your & Available Books</div>
    <button class="btn primary" id="postYourBookBtn" style="width:100%; margin-bottom:12px;">‚ûï Post Your Book</button>

    <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <div style="font-weight:600">Available Books</div>
      <select id="sortSelect" class="btn" style="background:transparent; padding:8px 10px;">
        <option value="recent">Newest</option>
        <option value="nearest">Nearest</option>
      </select>
    </div>
    <div id="booksList" style="margin-top:12px;"></div>
  </aside>

  <section>
    <div id="map"></div>
  </section>
</main>

<!-- POST BOOK MODAL -->
<div class="post-modal" id="postModal">
  <div class="post-content">
    <h3>Post Your Book</h3>
    <select id="bookType">
      <option value="individual">Individual Book</option>
      <option value="academic">Academic Book Set</option>
    </select>
    <input id="titleIn" type="text" placeholder="Book Title">
    <input id="authorIn" type="text" placeholder="Author / Set Name">
    <input id="whatsappIn" type="text" placeholder="WhatsApp Number">
    <input id="emailIn" type="text" placeholder="Email (optional)">
    <select id="categoryIn">
      <option>Fiction</option>
      <option>Non-Fiction</option>
      <option>Education</option>
      <option>Technology</option>
      <option>Kids</option>
    </select>
    <input id="imageIn" type="file" accept="image/*">
    <label><input type="checkbox" id="acceptPolicy"> I accept Privacy & Policy</label>
    <button id="submitBookBtn">Send for Approval</button>
    <button id="closeModalBtn" style="background:rgba(255,255,255,0.05);margin-top:8px;">Close</button>
    <div class="small">Your data is safe. Details will be sent to WhatsApp for review.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyB3kahd5nJOga4YUZnHATrPHu4Ief7b_64",
  authDomain: "book-nearme.firebaseapp.com",
  projectId: "book-nearme",
  storageBucket: "book-nearme.appspot.com",
  messagingSenderId: "857560283510",
  appId: "1:857560283510:web:9c4bd7f7dca04c35552257"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// THEME
const modeToggle = document.getElementById('modeToggle');
const modeLabel = document.getElementById('modeLabel');
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  modeLabel.innerText = theme==='dark'?'Dark':'Light';
  localStorage.setItem('bm_theme',theme);
}
modeToggle.addEventListener('change',()=>applyTheme(modeToggle.checked?'light':'dark'));
applyTheme(localStorage.getItem('bm_theme')||'dark');

// MAP INIT
let map = L.map('map').setView([26, 84],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// SHOW MY LOCATION
document.getElementById('myLocationBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('Geolocation not supported'); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    map.setView([lat,lng],12);
    L.circle([lat,lng],{radius:200,color:'#06b6d4',opacity:0.6}).addTo(map);
  },err=>alert('Location access denied or error'));
});

// SUBSCRIBE BUTTON
document.getElementById('subscribeBtn').addEventListener('click',()=>window.open("https://www.youtube.com/@nsjagat-c?sub_confirmation=1","_blank"));

// POST MODAL
const postModal = document.getElementById('postModal');
document.getElementById('postYourBookBtn').addEventListener('click',()=>postModal.style.display='flex');
document.getElementById('closeModalBtn').addEventListener('click',()=>postModal.style.display='none');
</script><script>
// UTILITY
function compressImage(file, maxSizeMB, callback){
  const reader = new FileReader();
  reader.onload = function(event){
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement('canvas');
      const scale = Math.sqrt((maxSizeMB*1024*1024)/(img.width*img.height*4));
      canvas.width = img.width*scale;
      canvas.height = img.height*scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(blob=>callback(blob), 'image/jpeg', 0.8);
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
}

// POST BOOK
document.getElementById('submitBookBtn').addEventListener('click', async ()=>{
  const type=document.getElementById('bookType').value;
  const title=document.getElementById('titleIn').value.trim();
  const author=document.getElementById('authorIn').value.trim();
  const whatsapp=document.getElementById('whatsappIn').value.trim();
  const email=document.getElementById('emailIn').value.trim();
  const category=document.getElementById('categoryIn').value;
  const file=document.getElementById('imageIn').files[0];
  const accept=document.getElementById('acceptPolicy').checked;

  if(!title||!author||!whatsapp||!file){ alert('Please fill all required fields'); return;}
  if(!accept){ alert('Accept Privacy & Policy'); return;}

  // GET LOCATION
  if(!navigator.geolocation){ alert('Geolocation not supported'); return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;

    // COMPRESS IMAGE
    compressImage(file,1,async blob=>{
      const imgRef = storage.ref().child(`books/${Date.now()}_${file.name}`);
      await imgRef.put(blob);
      const imgUrl = await imgRef.getDownloadURL();

      // SAVE IN FIRESTORE
      const bookData = {
        type, title, author, whatsapp, email, category,
        image: imgUrl, lat, lng,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        key: Date.now()
      };
      await db.collection('books').add(bookData);

      // SEND WHATSAPP LINK
      const msg=`New Book for review: ${title} by ${author}, WhatsApp: ${whatsapp}, Email: ${email||'N/A'}`;
      window.open(`https://wa.me/YOUR_NUMBER?text=${encodeURIComponent(msg)}`,'_blank');

      alert('Your data is safe. Sent for review.');
      postModal.style.display='none';
      loadBooks();
    });
  }, err=>alert('Location access denied or error'));
});

// LOAD BOOKS
async function loadBooks(sort='recent'){
  markersLayer.clearLayers();
  const listEl=document.getElementById('booksList');
  listEl.innerHTML='';

  const snapshot = await db.collection('books').orderBy('timestamp','desc').get();
  const books = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));

  // SORT
  if(sort==='nearest' && navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat0=pos.coords.latitude, lng0=pos.coords.longitude;
      books.sort((a,b)=>{
        const d1=Math.hypot(a.lat-lat0,a.lng-lng0);
        const d2=Math.hypot(b.lat-lat0,b.lng-lng0);
        return d1-d2;
      });
      renderBooks(books);
    });
  } else renderBooks(books);

  function renderBooks(books){
    books.forEach(b=>{
      const card=document.createElement('div'); card.className='book-card';
      card.innerHTML=`<img src="${b.image}"><div class="book-meta">
        <h4>${b.title}</h4>
        <p>${b.author}</p>
        <p>${b.category}</p>
        <p>Status: <strong>${b.status}</strong></p>
        <p class="small">Contact: ${b.whatsapp}</p>
      </div>`;
      listEl.appendChild(card);
      // ADD MARKER
      L.marker([b.lat,b.lng]).addTo(markersLayer)
        .bindPopup(`<b>${b.title}</b><br>${b.author}<br>${b.category}<br>Status: ${b.status}`);
    });
  }
}

// SORT CHANGE
document.getElementById('sortSelect').addEventListener('change',e=>{
  loadBooks(e.target.value);
});

// INITIAL LOAD
loadBooks();
</script>